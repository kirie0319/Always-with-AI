<!-- templates/financial/components/financial_strategy.html -->
<!-- Add Chart.js dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
  /* Chart container styles */
  .financial-chart-container {
    position: relative;
    margin: auto;
    height: 450px;
    width: 100%;
    max-width: 500px;
  }
</style>

<div id="investment-strategy-content" class="tab-content hidden">
    <div class="financial-step-container">
      <div class="financial-step-header">
        <div class="financial-step-number"><i class="fas fa-chart-line"></i></div>
        <div class="financial-step-title">ライフプランニング戦略提案</div>
      </div>
      
      <div class="financial-step-content">
        <p class="financial-instruction">お客様の状況に合わせた最適な資産運用プランをご提案します。</p>
        
        <!-- 投資戦略タブナビゲーション -->
        <div class="investment-tab-navigation">
          <button class="investment-tab-btn active" data-tab="currentOperation">現運用</button>
          <button class="investment-tab-btn" data-tab="strategy1">戦略パターン 1</button>
          <button class="investment-tab-btn" data-tab="strategy2">戦略パターン 2</button>
          <button class="investment-tab-btn" data-tab="strategy3">戦略パターン 3</button>
        </div>
        
        <!-- タブコンテンツ -->
        <div class="investment-container">
          <!-- 現在の分析 -->
          <div id="currentOperation" class="investment-strategy-tab active">
            <div id="currentAnalysisContent" class="markdown-content">
              <h3 class="financial-subtitle">現運用の状況</h3>
              <p class="financial-description">現在の資産状況と主な課題点についてまとめました。</p>
              
              <div class="financial-section">
                <h4 class="financial-section-title">現運用の課題</h4>
                <div class="financial-content">
                  <div class="financial-issue">
                    <h5 class="financial-issue-title">教育資金準備の不足:</h5>
                    <ul class="financial-list">
                      <li>現在の変額年金保険(80万円)だけでは、目標の長男・長女各800万円に対して大幅に不足しています。</li>
                      <li>毎月の積立額が2万円では、大学入学時までに目標額に到達する可能性が低いです。</li>
                    </ul>
                  </div>
                  <div class="financial-issue">
                    <h5 class="financial-issue-title">老後資金の準備不足:</h5>
                    <ul class="financial-list">
                      <li>退職金がない中、iDeCo(月2.3万円)と定額保険だけでは65歳以降の年間276万円の赤字を賄うには不十分です。</li>
                      <li>年金だけでは月々の支出をカバーできません。</li>
                    </ul>
                  </div>
                  <div class="financial-issue">
                    <h5 class="financial-issue-title">資金需要の集中時期への対応:</h5>
                    <ul class="financial-list">
                      <li>55～60歳に子供の大学教育費とリフォーム費用が集中するため、一時的な資金不足のリスクがあります。</li>
                      <li>単年収支がマイナスとなる時期の資金確保が課題です。</li>
                    </ul>
                  </div>
                  <div class="financial-issue">
                    <h5 class="financial-issue-title">投資効率の最適化:</h5>
                    <ul class="financial-list">
                      <li>低金利(0.75%)の住宅ローンがある一方で、資産運用の効率化が図れていません。</li>
                      <li>現状の資産配分では成長重視型のリスク許容度を十分に活かしきれていません。</li>
                    </ul>
                  </div>
                  <div class="financial-issue">
                    <h5 class="financial-issue-title">目的別資産形成の明確化:</h5>
                    <ul class="financial-list">
                      <li>現在の資産配分が、明確な目的別に最適化されていません。</li>
                      <li>投資目的に応じたリスク調整ができていません。</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">現在のポートフォリオ</h4>
                <div class="financial-table-container">
                  <table class="financial-table">
                    <thead>
                      <tr>
                        <th>商品カテゴリー</th>
                        <th class="text-right">保有金額</th>
                        <th>特徴/備考</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>株式</td>
                        <td class="text-right">250万円</td>
                        <td>運用期間17年</td>
                      </tr>
                      <tr>
                        <td>投資信託</td>
                        <td class="text-right">150万円</td>
                        <td>運用期間17年</td>
                      </tr>
                      <tr>
                        <td>逓減定期保険</td>
                        <td class="text-right">100万円</td>
                        <td>毎月2.5万円の保険料、60歳で解約返戻金600万円</td>
                      </tr>
                      <tr>
                        <td>変額年金保険</td>
                        <td class="text-right">80万円</td>
                        <td>毎月2万円積立、積立元本50万円</td>
                      </tr>
                      <tr>
                        <td>iDeCo</td>
                        <td class="text-right">80万円</td>
                        <td>毎月2.3万円積立中</td>
                      </tr>
                      <tr>
                        <td>定額保険</td>
                        <td class="text-right">190万円</td>
                        <td>60歳満期、解約返戻金約500万円</td>
                      </tr>
                      <tr>
                        <td>普通預金等</td>
                        <td class="text-right">500万円</td>
                        <td>-</td>
                      </tr>
                      <tr>
                        <td>普通預金等 (配偶者名義)</td>
                        <td class="text-right">500万円</td>
                        <td>-</td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td>合計</td>
                        <td class="text-right">1,850万円</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">現在のポートフォリオ構成</h4>
                <div class="financial-chart-container">
                  <canvas id="portfolioPieChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        
          <!-- 戦略 1 -->
          <div id="strategy1" class="investment-strategy-tab">
            <div id="strategy1Content" class="markdown-content">
              <h3 class="financial-subtitle">戦略パターン 1: 子どもの教育資金準備と老後資金の両立</h3>
              <p class="financial-description">教育費のピークと老後の生活費双方に対応するバランス型戦略。</p>
              
              <div class="financial-section">
                <h4 class="financial-section-title">提案理由</h4>
                <p class="financial-content">
                  55歳から60歳にかけて子どもの大学教育費で単年収支がマイナスになり、65歳以降も年金生活で収支がマイナスになるため、この2つの時期に向けた資産形成が必要です。
                </p>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">具体的な戦略</h4>
                <ul class="financial-list">
                  <li>現在の貯蓄500万円のうち300万円を利回り5%が見込める投資信託で中長期運用。</li>
                  <li>毎月15万円の積立を開始し、10万円を利回り4%の投資信託、5万円を利回り3%の一時払い保険に配分。</li>
                  <li>子どもの教育資金は別枠で設定し、変額年金保険の毎月の積立を2万円から4万円に増額 (長男・長女用それぞれ2万円)。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">期待成果</h4>
                <ul class="financial-list">
                  <li>55歳時点で子どもの大学教育資金として約1,600万円確保。</li>
                  <li>65歳退職時には約6,000万円の資産形成が可能となり、年金と併せて安定した後生活が実現。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">商品ポートフォリオ</h4>
                <div class="financial-table-container">
                  <table class="financial-table">
                    <thead>
                      <tr>
                        <th>目的</th>
                        <th>商品名</th>
                        <th>投資金額/積立額</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>子ども教育資金</td>
                        <td>荘内銀行変額年金保険</td>
                        <td>毎月4万円積立 (長男・長女各2万円)</td>
                      </tr>
                      <tr>
                        <td>中長期運用資金</td>
                        <td>荘内銀行投信ファンドラップ</td>
                        <td>貯蓄から300万円</td>
                      </tr>
                      <tr>
                        <td>安定資産形成</td>
                        <td>荘内バランスファンド</td>
                        <td>毎月10万円積立</td>
                      </tr>
                      <tr>
                        <td>退職準備資金</td>
                        <td>荘内銀行一時払い終身保険</td>
                        <td>毎月5万円</td>
                      </tr>
                      <tr>
                        <td>老後資金補完</td>
                        <td>荘内銀行iDeCo</td>
                        <td>毎月2.3万円から2.7万円に増額</td>
                      </tr>
                      <tr>
                        <td>緊急予備資金</td>
                        <td>荘内スーパー定期</td>
                        <td>貯蓄から200万円</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        
          <!-- 戦略 2 -->
          <div id="strategy2" class="investment-strategy-tab">
            <div id="strategy2Content" class="markdown-content">
              <h3 class="financial-subtitle">戦略パターン 2: 住宅ローン繰上返済と資産運用の最適化</h3>
              <p class="financial-description">低金利の住宅ローンを活用し、余剰資金を積極的な資産運用に回す戦略。</p>
              
              <div class="financial-section">
                <h4 class="financial-section-title">提案理由</h4>
                <p class="financial-content">
                  住宅ローンの金利が0.75%と低く、運用による利回りの方が高い可能性があるため、完済を急がず余剰資金を運用に回すことで、トータルでの資産形成を最大化できます。
                </p>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">具体的な戦略</h4>
                <ul class="financial-list">
                  <li>住宅ローンの繰上返済は見送り、余剰資金は運用に回す。</li>
                  <li>毎月20万円の積立を実施し、10万円を利回り5%の投資信託(グロース株中心)、6万円を利回り4%のバランス型投資信託、4万円を利回り2%の債券型投資信託に配分。</li>
                  <li>iDeCoの拠出金額を月々2.3万円から2.7万円(上限)に引き上げ。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">期待成果</h4>
                <ul class="financial-list">
                  <li>資産運用による期待リターンが住宅ローン金利を上回り、55歳時点で約5,000万円の資産形成。</li>
                  <li>税制優遇のあるiDeCoを最大活用することで、退職時の資産を効率的に増やす。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">商品ポートフォリオ</h4>
                <div class="financial-table-container">
                  <table class="financial-table">
                    <thead>
                      <tr>
                        <th>目的</th>
                        <th>商品名</th>
                        <th>投資金額/積立額</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>成長資産形成</td>
                        <td>荘内米国株式ファンド</td>
                        <td>毎月10万円積立</td>
                      </tr>
                      <tr>
                        <td>バランス運用</td>
                        <td>荘内ESG投資ファンド</td>
                        <td>毎月6万円積立</td>
                      </tr>
                      <tr>
                        <td>安定運用</td>
                        <td>荘内日本国債ファンド</td>
                        <td>毎月4万円積立</td>
                      </tr>
                      <tr>
                        <td>退職後資金</td>
                        <td>iDeCo</td>
                        <td>毎月2.3万円から2.7万円に増額</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        
          <!-- 戦略 3 -->
          <div id="strategy3" class="investment-strategy-tab">
            <div id="strategy3Content" class="markdown-content">
              <h3 class="financial-subtitle">戦略パターン 3: リスク分散と目的別資金の明確化</h3>
              <p class="financial-description">リスク許容度に合わせて、各ライフイベントに必要な資金を明確に分けて準備する戦略。</p>
              
              <div class="financial-section">
                <h4 class="financial-section-title">提案理由</h4>
                <p class="financial-content">
                  お客様は成長重視型のリスク許容度をお持ちですが、目的や時期によって適切なリスク水準は異なります。目的別に資金を分けて運用することで、必要なときに必要な資金を確保しやすくなります。
                </p>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">具体的な戦略</h4>
                <ul class="financial-list">
                  <li>住宅ローンの繰上返済は見送り、余剰資金は運用に回す。</li>
                  <li>毎月20万円の積立を実施。内訳は、目的別にリスク・リターンを考慮して配分。
                    <ul class="financial-sublist">
                      <li>教育資金向け: 比較的安定的ながら成長も期待できるファンド</li>
                      <li>リフォーム資金向け: 使用時期を考慮した安定運用</li>
                      <li>老後資金向け: 長期的な成長を重視したファンド</li>
                    </ul>
                  </li>
                  <li>iDeCoの拠出金額を月々2.3万円から2.7万円(上限)に引き上げ。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">期待成果</h4>
                <ul class="financial-list">
                  <li>各目的に応じた最適なリスク・リターンのバランスで資産形成。</li>
                  <li>55歳時点で教育資金約1,800万円、リフォーム資金約400万円を確保。</li>
                  <li>65歳退職時には退職後資金として約5,500万円の形成が可能。</li>
                </ul>
              </div>

              <div class="financial-section">
                <h4 class="financial-section-title">商品ポートフォリオ</h4>
                <div class="financial-table-container">
                  <table class="financial-table">
                    <thead>
                      <tr>
                        <th>目的</th>
                        <th>商品名</th>
                        <th>投資金額/積立額</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>教育資金</td>
                        <td>荘内グローバル資産分散ファンド</td>
                        <td>毎月6万円積立</td>
                      </tr>
                      <tr>
                        <td>リフォーム資金</td>
                        <td>荘内ワールド・ソブリンインカム</td>
                        <td>現在の貯蓄から100万円</td>
                      </tr>
                      <tr>
                        <td>退職後資金</td>
                        <td>荘内米国株式ファンド</td>
                        <td>毎月10万円積立</td>
                      </tr>
                      <tr>
                        <td>緊急予備資金</td>
                        <td>荘内普通預金</td>
                        <td>現在の貯蓄から200万円</td>
                      </tr>
                      <tr>
                        <td>退職後資金(補完)</td>
                        <td>荘内外貨定期預金(米ドル)</td>
                        <td>既存の投資信託150万円を切替</td>
                      </tr>
                      <tr>
                        <td>iDeCo</td>
                        <td>iDeCo</td>
                        <td>毎月2.7万円に増額</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="financial-button-container">
          <button class="financial-action-button return-to-customer-info">顧客情報に戻る</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Register ChartDataLabels plugin globally
Chart.register(ChartDataLabels);

// Tab switching functionality
const tabButtons = document.querySelectorAll('.investment-tab-btn');
const tabContents = document.querySelectorAll('.investment-strategy-tab');

function activateTab(tabId) {
  tabButtons.forEach(btn => btn.classList.remove('active'));
  tabContents.forEach(content => content.classList.remove('active'));

  const button = document.querySelector(`.investment-tab-btn[data-tab="${tabId}"]`);
  const content = document.getElementById(tabId);
  if (button && content) {
    button.classList.add('active');
    content.classList.add('active');
  }
  if (tabId === 'currentOperation') {
    renderPortfolioChart();
  }
}

tabButtons.forEach(button => {
  button.addEventListener('click', () => {
    const tabId = button.getAttribute('data-tab');
    activateTab(tabId);
  });
});

let portfolioChartInstance = null;

function renderPortfolioChart() {
  const ctx = document.getElementById('portfolioPieChart');
  if (!ctx) return;

  if (portfolioChartInstance) {
    portfolioChartInstance.destroy();
  }

  const data = {
    labels: [
      '株式', '投資信託', '逓減定期保険', '変額年金保険',
      'iDeCo', '定額保険', '普通預金等', '普通預金等 (配偶者名義)'
    ],
    datasets: [{
      label: 'ポートフォリオ構成 (万円)',
      data: [250, 150, 100, 80, 80, 190, 500, 500],
      backgroundColor: [
        '#0b5394', '#3d85c6', '#6fa8dc', '#9fc5e8',
        '#cfe2f3', '#3c78d8', '#2a5699', '#1155cc',
        '#4a86e8', '#76a5af'
      ],
      borderColor: '#fff',
      borderWidth: 1,
      hoverOffset: 8
    }]
  };

  const config = {
    type: 'pie',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 30,
          bottom: 30,
          left: 30,
          right: 30
        }
      },
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed !== null) {
                label += context.parsed.toLocaleString('ja-JP') + '万円';
              }
              return label;
            }
          }
        },
        datalabels: {
          display: true,
          formatter: (value, context) => {
            const label = context.chart.data.labels[context.dataIndex];
            const percentage = ((value / context.chart.getDatasetMeta(0).total) * 100);
            if (percentage < 3) {
              return '';
            }
            let displayLabel = label;
            if (displayLabel === '普通預金等 (配偶者名義)') {
              displayLabel = '普通預金(配偶者)';
            } else if (displayLabel === '逓減定期保険') {
              displayLabel = '逓減定期';
            } else if (displayLabel === '変額年金保険') {
              displayLabel = '変額年金';
            }
            
            return displayLabel + '\n' + percentage.toFixed(1) + '%';
          },
          color: '#ffffff',
          anchor: 'end',
          align: 'end',
          offset: 8,
          backgroundColor: (context) => {
            return context.dataset.backgroundColor[context.dataIndex];
          },
          borderColor: '#ffffff',
          borderWidth: 1,
          borderRadius: 4,
          padding: 4,
          font: {
            size: 9,
            weight: 'bold'
          },
          textAlign: 'center'
        }
      }
    },
  };

  portfolioChartInstance = new Chart(ctx, config);
}

activateTab('currentOperation');
</script>