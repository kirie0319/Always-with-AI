<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobility Supporter AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- 外部CSSファイルの読み込み -->
  <link rel="stylesheet" href="/static/css/mobility.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>

<body>
  <!-- サイドバー -->
  <div class="sidebar">
    <!-- ヘッダー -->
    <div class="sidebar-header">
      <div class="sidebar-logo">Mobility Supporter</div>
      <button class="toggle-btn">»</button>
    </div>

    <!-- メニュー -->
    <ul class="sidebar-menu">
      <li class="menu-item active">
        <a href="#" class="menu-link">
          <div class="menu-icon">
            <i class="fas fa-car"></i>
          </div>
          <span href="/mobility" class="menu-text" onclick="window.location.href='/mobility'">提案サポート</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="/mobility/knowledge" class="menu-link">
          <div class="menu-icon">
            <i class="fas fa-lightbulb"></i>
          </div>
          <span href="/mobility/knowledge" class="menu-text" onclick="window.location.href='/mobility/knowledge'">ナレッジシェア</span>
        </a>
      </li>
    </ul>
    
    <!-- フッター -->
    <div class="sidebar-footer">
      <div class="sidebar-footer-text">Mobility Supporter AI © 2025</div>
    </div>
  </div>

  <!-- メインアプリケーションコンテナ -->
  <div class="app-container">
    <div class="chat-container mobility-container">
      <div class="chat-header">
        <div class="logo">
          <i class="fas fa-car"></i>
          <h1><span class="accent-letter">M</span>obility <span class="accent-letter">S</span>upporter <span
              class="accent-letter">AI</span></h1>
        </div>
      </div>

      <div class="navigation-button-container">
        <a href="/prompt" class="nav-btn">
          <i class="fas fa-edit"></i> プロンプトを編集する
        </a>
        <a href="/select" class="nav-btn">
          <i class="fas fa-list-alt"></i> プロンプトを選択する
        </a>
        <a href="/" class="nav-btn return-to-admin">
          <i class="fas fa-arrow-left"></i> 管理画面に戻る
        </a>
      </div>

      <!-- 選択中のプロンプト表示エリア -->
      <div id="active-prompt" class="active-prompt">
        <div class="active-prompt-label">
          <i class="fas fa-check-circle"></i> 現在のプロンプト:
        </div>
        <div id="prompt-name" class="active-prompt-name">デフォルト</div>
      </div>

      <!-- メインコンテンツ -->
      <div class="mobility-main-content">
        <!-- 左側：入力フォームエリア -->
        <div class="mobility-form-container">
          <!-- 顧客情報タブのコンテンツ -->
          <div id="customer-info-content" class="tab-content active">
            <!-- Step 0: CRM連携 -->
            <div id="step-0" class="mobility-step-container">
              <div class="mobility-step-header">
                <div class="mobility-step-number">Step 0</div>
                <div class="mobility-step-title">CRM情報と連携する</div>
              </div>

              <div class="mobility-step-content">
                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="cif">Salesforce ID</label>
                  <input type="text" id="cif" value="6238196171983">
                </div>

                <div class="first-mobility-button-container">
                  <button id="connect-info-btn" class="mobility-action-button">情報を連携する</button>
                </div>
              </div>
            </div>

            <!-- Step 1: 本人情報入力 -->
            <div id="step-1" class="mobility-step-container hidden">
              <div class="mobility-step-header">
                <div class="mobility-step-number">Step 2</div>
                <div class="mobility-step-title">顧客の基本情報</div>
              </div>

              <div class="mobility-step-content">
                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="name">名前</label>
                  <input type="text" id="name" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="age">年齢</label>
                  <input type="number" id="age" value="">
                  <span>歳</span>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="dealer">取引歴</label>
                  <select id="dealer">
                    <option value="自社" selected>自社客</option>
                    <option value="他社">他社</option>
                  </select>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="phone">電話番号</label>
                  <input type="tel" id="phone" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="family-size">家族構成</label>
                  <input type="number" id="family-size" value="">
                  <span>人</span>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="hobby">趣味</label>
                  <input type="text" id="hobby" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="next-car">次乗り換えたい車</label>
                  <input type="text" id="next-car" value="">
                  <div class="support-button">T</div>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="insurance">任意保険加入状況</label>
                  <select id="insurance">
                    <option value="他社" selected>他社</option>
                    <option value="自社">自社</option>
                    <option value="なし">なし</option>
                  </select>
                  <div class="support-button">T</div>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="insurance-company">保険会社名</label>
                  <input type="text" id="insurance-company" value="">
                  <div class="support-button">T</div>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="insurance-type">種別</label>
                  <select id="insurance-type">
                    <option value="国内損保" selected>国内損保</option>
                    <option value="国内生保">国内生保</option>
                    <option value="外資系">外資系</option>
                  </select>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="insurance-rank">等級</label>
                  <input type="text" id="insurance-rank" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="accident-category">事故り区分</label>
                  <input type="text" id="accident-category" value="">
                </div>

                <div class="mobility-button-container">
                  <button id="back-to-step-0" class="mobility-secondary-button">前へ戻る</button>
                  <button id="next-to-step-2" class="mobility-action-button">次へ進む</button>
                </div>
              </div>
            </div>
            
            <!-- Step 3: 家計状況 -->
            <div id="step-3" class="mobility-step-container hidden">
              <div class="mobility-step-header">
                <div class="mobility-step-number">Step 3</div>
                <div class="mobility-step-title">家計状況</div>
              </div>

              <div class="mobility-step-content">
                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="housing-loan">家賃・住宅ローン</label>
                  <select id="housing-loan">
                    <option value="有り" selected>有り</option>
                    <option value="なし">なし</option>
                  </select>
                  <div class="support-button">T</div>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="household-income">世帯年収</label>
                  <input type="number" id="household-income" value="">
                  <span>万円</span>
                </div>

                <div class="mobility-button-container">
                  <button id="back-to-step-2" class="mobility-secondary-button">前へ戻る</button>
                  <button id="next-to-step-4" class="mobility-action-button">次へ進む</button>
                </div>
              </div>
            </div>
            
            <!-- Step 4: 車両情報 -->
            <div id="step-4" class="mobility-step-container hidden">
              <div class="mobility-step-header">
                <div class="mobility-step-number">Step 4</div>
                <div class="mobility-step-title">車両情報</div>
              </div>

              <div class="mobility-step-content">
                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="car-type">車種</label>
                  <input type="text" id="car-type" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="car-year">年式</label>
                  <input type="text" id="car-year" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="inspection-date">車検満了日</label>
                  <input type="date" id="inspection-date" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label required" for="mileage">走行距離</label>
                  <input type="number" id="mileage" value="">
                  <span>万km</span>
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="car-number">ナンバー</label>
                  <input type="text" id="car-number" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="service-history">入庫歴</label>
                  <input type="text" id="service-history" value="">
                </div>

                <div class="mobility-input-row">
                  <label class="mobility-input-row-label" for="car-color">車種の色</label>
                  <input type="text" id="car-color" value="">
                </div>

                <div class="mobility-button-container">
                  <button id="back-to-step-3" class="mobility-secondary-button">前へ戻る</button>
                  <button id="next-to-step-5" class="mobility-action-button">次へ進む</button>
                </div>
              </div>
            </div>
            
            <!-- Step 5: 車両コスト比較 -->
            <div id="step-5" class="mobility-step-container hidden">
              <div class="mobility-step-header">
                <div class="mobility-step-number">Step 5</div>
                <div class="mobility-step-title">車両コスト比較（3年間）</div>
              </div>

              <div class="mobility-step-content">
                <!-- 現在の車両 セクション -->
                <div class="mobility-section-container">
                  <div class="mobility-section-title">現在の車両</div>
                  <div class="mobility-section-content" style="padding: 16px;">
                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label required" for="current-car-type">車種</label>
                      <input type="text" id="current-car-type" value="">
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label required" for="current-car-model">型式</label>
                      <input type="text" id="current-car-model" value="">
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label required" for="annual-mileage">年間走行距離</label>
                      <input type="number" id="annual-mileage" value="">
                      <span>万km</span>
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="car-tax">自動車税（3回）</label>
                      <input type="number" id="car-tax" value="">
                      <span>万円</span>
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="inspection-cost">車検（2回）</label>
                      <input type="number" id="inspection-cost" value="">
                      <span>万円</span>
                    </div>
                  </div>
                </div>

                <!-- 比較の車両 セクション -->
                <div class="mobility-section-container" style="margin-top: 20px;">
                  <div class="mobility-section-title">比較の車両 ①</div>
                  <div class="mobility-section-content" style="padding: 16px;">
                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="compare-car-type">車種</label>
                      <input type="text" id="compare-car-type" value="">
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="compare-car-tax">自動車税（3回）</label>
                      <input type="number" id="compare-car-tax" value="">
                      <span>万円</span>
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="compare-inspection-cost">車検（2回）</label>
                      <input type="number" id="compare-inspection-cost" value="">
                      <span>万円</span>
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="preferred-maker">希望比較メーカー</label>
                      <input type="text" id="preferred-maker" value="">
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="preferred-car-type">希望比較車種</label>
                      <input type="text" id="preferred-car-type" value="">
                    </div>

                    <div class="mobility-input-row">
                      <label class="mobility-input-row-label" for="preferred-car-model">希望比較車種型式</label>
                      <input type="text" id="preferred-car-model" value="">
                    </div>
                  </div>
                </div>

                <!-- 比較車両追加ボタン -->
                <div class="mobility-add-section" style="margin-top: 20px; text-align: center;">
                  <button id="add-car-comparison" class="mobility-secondary-button" style="width: 100%; padding: 12px;">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i> 
                  </button>
                </div>

                <div class="mobility-button-container" style="margin-top: 30px;">
                  <button id="back-to-step-4" class="mobility-secondary-button">前へ戻る</button>
                  <button id="complete-form-final" class="mobility-action-button">登録する</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 右側：チャットメッセージエリア -->
        <div class="mobility-response-container">
          <!-- チャットメッセージ表示エリア -->
          <div class="chat-messages" id="chat-box">
            <div class="message bot">
              <div class="avatar">
                <i class="fas fa-robot"></i>
              </div>
              <div class="message-content">
                <p>こんにちは！<br>まずは左側「CRM情報と連携する」にある情報を連携するボタンをクリックしてください☺️</p>
                <span class="timestamp">今</span>
              </div>
            </div>
          </div>

          <!-- 入力フォーム - 右側のチャットエリアに含める -->
          <div class="chat-input">
            <div class="input-container">
              <input type="text" id="input" placeholder="例：車の購入について相談したいです..." />
              <button id="send-btn">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            <div class="actions">
              <button id="clear-btn" onclick="clearChat()" class="secondary-btn">
                <i class="fas fa-trash-alt"></i> チャットをクリア
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const chatBox = document.getElementById('chat-box');
    const inputField = document.getElementById('input');
    const sendButton = document.getElementById('send-btn');
    const promptNameElement = document.getElementById('prompt-name');
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      inputField.focus();

      // マークダウンの設定
      marked.setOptions({
        breaks: true, // 改行をbrタグに変換
        gfm: true,    // GitHub Flavored Markdown を有効化
        highlight: function (code, lang) {
          // コードのハイライト（highlight.jsを使用している場合）
          if (hljs && lang && hljs.getLanguage(lang)) {
            try {
              return hljs.highlight(code, { language: lang }).value;
            } catch (e) { }
          }
          return code;
        }
      });

      // Submit on Enter key
      inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          send();
        }
      });

      // Send button click event
      sendButton.addEventListener('click', send);

      // セッションストレージから選択中のプロンプト名を取得して表示
      const selectedPromptName = sessionStorage.getItem('selectedPromptName');
      if (selectedPromptName) {
        promptNameElement.textContent = selectedPromptName;
      }
      
      // DOM要素の取得
      const menuItems = document.querySelectorAll('.menu-item');
      const toggleBtn = document.querySelector('.toggle-btn');
      const sidebar = document.querySelector('.sidebar');
      const step0 = document.getElementById('step-0');
      const step1 = document.getElementById('step-1');
      const step3 = document.getElementById('step-3');
      const step4 = document.getElementById('step-4');
      const step5 = document.getElementById('step-5');
      
      // ボタン参照
      const connectInfoBtn = document.getElementById('connect-info-btn');
      const backToStep0Btn = document.getElementById('back-to-step-0');
      const nextToStep2Btn = document.getElementById('next-to-step-2');
      const backToStep2Btn = document.getElementById('back-to-step-2');
      const nextToStep4Btn = document.getElementById('next-to-step-4');
      const backToStep3Btn = document.getElementById('back-to-step-3');
      const nextToStep5Btn = document.getElementById('next-to-step-5');
      const backToStep4Btn = document.getElementById('back-to-step-4');
      const completeFormFinalBtn = document.getElementById('complete-form-final');
      const addCarComparisonBtn = document.getElementById('add-car-comparison');
      const optionButtons = document.querySelectorAll('.mobility-option-button');
      const supportButtons = document.querySelectorAll('.support-button');

      // 現在のステップを管理
      let currentStep = 0;

      // ステップの表示/非表示を更新する関数
      function updateStepVisibility() {
        [step0, step1, step3, step4, step5].forEach(step => {
          if (step) step.classList.add('hidden');
        });

        // 現在のステップを表示
        switch (currentStep) {
          case 0: if (step0) step0.classList.remove('hidden'); break;
          case 1: if (step1) step1.classList.remove('hidden'); break;
          case 3: if (step3) step3.classList.remove('hidden'); break;
          case 4: if (step4) step4.classList.remove('hidden'); break;
          case 5: if (step5) step5.classList.remove('hidden'); break;
        }
        
        document.body.setAttribute('data-current-step', currentStep);
      }

      // サイドバーの折りたたみ/展開
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          toggleBtn.innerHTML = sidebar.classList.contains('collapsed') ? '«' : '»';
        });
      }

      // サイドメニュークリック処理
      menuItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          menuItems.forEach(mi => mi.classList.remove('active'));
          item.classList.add('active');
        });
      });

      // 情報連携ボタン (Step 0 -> Step 1)
      if (connectInfoBtn) {
        connectInfoBtn.addEventListener('click', () => {
          currentStep = 1;
          updateStepVisibility();
          appendMessage('bot', 'CRM情報の連携が完了しました。顧客の基本情報に入力をお願いします。名前と年齢は必須項目となっています。');
        });
      }

      // 前へボタン (Step 1 -> Step 0)
      if (backToStep0Btn) {
        backToStep0Btn.addEventListener('click', () => {
          currentStep = 0;
          updateStepVisibility();
        });
      }

      // 次へボタン (Step 1 -> Step 3)
      if (nextToStep2Btn) {
        nextToStep2Btn.addEventListener('click', () => {
          // 必須項目のチェック
          const nameField = document.getElementById('name');
          const ageField = document.getElementById('age');
          
          if (!nameField.value.trim()) {
            alert('名前は必須項目です。入力してください。');
            nameField.focus();
            return;
          }
          
          if (!ageField.value.trim()) {
            alert('年齢は必須項目です。入力してください。');
            ageField.focus();
            return;
          }
          
          // Step 3に進む
          currentStep = 3;
          updateStepVisibility();
          appendMessage('bot', '基本情報の入力ありがとうございます。次に家計状況についてお聞かせください。');
        });
      }
      
      // 前へボタン (Step 3 -> Step 1)
      if (backToStep2Btn) {
        backToStep2Btn.addEventListener('click', () => {
          currentStep = 1;
          updateStepVisibility();
        });
      }
      
      // 次へボタン (Step 3 -> Step 4)
      if (nextToStep4Btn) {
        nextToStep4Btn.addEventListener('click', () => {
          // 必須項目のチェック
          const housingLoanField = document.getElementById('housing-loan');
          
          if (!housingLoanField.value) {
            alert('家賃・住宅ローンは必須項目です。選択してください。');
            housingLoanField.focus();
            return;
          }
          
          // Step 4に進む
          currentStep = 4;
          updateStepVisibility();
          appendMessage('bot', '家計状況の入力ありがとうございます。次に車両情報についてお聞かせください。');
        });
      }
      
      // 前へボタン (Step 4 -> Step 3)
      if (backToStep3Btn) {
        backToStep3Btn.addEventListener('click', () => {
          currentStep = 3;
          updateStepVisibility();
        });
      }
      
      // 次へボタン (Step 4 -> Step 5)
      if (nextToStep5Btn) {
        nextToStep5Btn.addEventListener('click', () => {
          // 必須項目のチェック
          const carTypeField = document.getElementById('car-type');
          const carYearField = document.getElementById('car-year');
          const inspectionDateField = document.getElementById('inspection-date');
          const mileageField = document.getElementById('mileage');
          
          if (!carTypeField.value.trim()) {
            alert('車種は必須項目です。入力してください。');
            carTypeField.focus();
            return;
          }
          
          if (!carYearField.value.trim()) {
            alert('年式は必須項目です。入力してください。');
            carYearField.focus();
            return;
          }
          
          if (!inspectionDateField.value) {
            alert('車検満了日は必須項目です。入力してください。');
            inspectionDateField.focus();
            return;
          }
          
          if (!mileageField.value) {
            alert('走行距離は必須項目です。入力してください。');
            mileageField.focus();
            return;
          }
          
          // Step 5に進む
          currentStep = 5;
          updateStepVisibility();
          appendMessage('bot', '車両情報の入力ありがとうございます。次に車両コスト比較についてお聞かせください。現在の車両情報と、比較したい車両の情報を入力してください。');
          
          // 自動的に現在の車両情報をStep 4の情報から転記
          if (carTypeField.value) {
            document.getElementById('current-car-type').value = carTypeField.value;
          }
        });
      }
      
      // 前へボタン (Step 5 -> Step 4)
      if (backToStep4Btn) {
        backToStep4Btn.addEventListener('click', () => {
          currentStep = 4;
          updateStepVisibility();
        });
      }
      
      // 比較車両追加ボタン
      if (addCarComparisonBtn) {
        addCarComparisonBtn.addEventListener('click', () => {
          alert('この機能は現在開発中です。次期アップデートでご利用いただけるようになります。');
        });
      }
      
      // 最終登録完了ボタン
      if (completeFormFinalBtn) {
        completeFormFinalBtn.addEventListener('click', () => {
          // 必須項目のチェック
          const currentCarTypeField = document.getElementById('current-car-type');
          const currentCarModelField = document.getElementById('current-car-model');
          const annualMileageField = document.getElementById('annual-mileage');
          
          if (!currentCarTypeField.value.trim()) {
            alert('現在の車両の車種は必須項目です。入力してください。');
            currentCarTypeField.focus();
            return;
          }
          
          if (!currentCarModelField.value.trim()) {
            alert('現在の車両の型式は必須項目です。入力してください。');
            currentCarModelField.focus();
            return;
          }
          
          if (!annualMileageField.value) {
            alert('年間走行距離は必須項目です。入力してください。');
            annualMileageField.focus();
            return;
          }
          
          // 完了メッセージを表示
          appendMessage('bot', 'すべての情報の入力ありがとうございます！車両コスト比較情報も含めて登録されました。比較結果は後ほど担当者よりご連絡いたします。今後の車検案内や保険更新のご案内、車の買い替え時期など、適切なタイミングでご連絡させていただきます。他にご質問などがありましたら、チャットでお気軽にお聞きください。');
        });
      }

      // オプションボタンの選択処理
      if (optionButtons) {
        optionButtons.forEach((button) => {
          button.addEventListener('click', () => {
            // 同じグループ内の他のボタンからアクティブクラスを削除
            const parentGroup = button.closest('.mobility-button-group');
            if (parentGroup) {
              parentGroup.querySelectorAll('.mobility-option-button').forEach((groupButton) => {
                groupButton.classList.remove('active');
              });
            }

            // クリックされたボタンにアクティブクラスを追加
            button.classList.add('active');
          });
        });
      }

      // サポートボタン（T）クリック
      if (supportButtons) {
        supportButtons.forEach(btn => {
          btn.addEventListener('click', (e) => {
            const fieldName = e.target.closest('.mobility-input-row').querySelector('label').textContent;
            appendMessage('bot', `「${fieldName}」について何かお手伝いできることはありますか？情報の入力方法や、この項目の重要性についてご説明できます。`);
          });
        });
      }

      // サイドバーメニューのナビゲーション処理
      const knowledgeMenuItem = document.querySelector('.menu-item:nth-child(2) .menu-link');
      if (knowledgeMenuItem) {
        knowledgeMenuItem.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/mobility/knowledge';
        });
      }

      // トークン認証の確認
      const token = localStorage.getItem('access_token');
      if (!token) {
        console.error('アクセストークンがありません。ログインページにリダイレクトします。');
        window.location.href = '/login';
      } else {
        console.log('アクセストークンが見つかりました。トークンの最初の10文字: ' + token.substring(0, 10) + '...');

        // トークンの検証リクエストを送信
        fetch('/validate-token', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('トークン検証に失敗しました');
            }
            return response.json();
          })
          .then(data => {
            console.log('トークン検証成功:', data);
          })
          .catch(error => {
            console.error('トークン検証エラー:', error);
            // トークンが無効な場合はログインページにリダイレクト
            localStorage.removeItem('access_token');
            window.location.href = '/login?invalid_token=true';
          });
      }
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('access_token');
      return token ? {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      } : {
        'Content-Type': 'application/json'
      };
    }

    // Format timestamp
    function formatTimestamp() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // マークダウンをパースして安全に描画する関数
    function renderMarkdown(text) {
      // DOMPurifyを使用している場合はここでサニタイズする
      // return DOMPurify.sanitize(marked.parse(text));
      return marked.parse(text);
    }

    // マークダウンかどうかを判定する関数
    function containsMarkdown(text) {
      // 一般的なマークダウン記法をチェック
      const markdownPatterns = [
        /\*\*.*?\*\*/,           // 太字 **bold**
        /\*.*?\*/,               // 斜体 *italic*
        /`.*?`/,                 // インラインコード `code`
        /```[\s\S]*?```/,        // コードブロック ```code```
        /^#+\s+.*/m,             // 見出し # Heading
        /^\s*[-*+]\s+.*/m,       // リスト - item
        /^\s*\d+\.\s+.*/m,       // 数字リスト 1. item
        /\[.*?\]\(.*?\)/,        // リンク [link](url)
        /!\[.*?\]\(.*?\)/,       // 画像 ![alt](url)
        /^\s*>\s+.*/m,           // 引用 > quote
        /^\s*---+\s*$/m,         // 水平線 ---
        /\|\s.*\s\|/             // テーブル | table |
      ];

      // いずれかのパターンにマッチすればマークダウンと判定
      return markdownPatterns.some(pattern => pattern.test(text));
    }

    // Add message to chat - LINE/WhatsAppスタイルのチャット
    function appendMessage(role, text) {
      const timestamp = formatTimestamp();
      const messageDiv = document.createElement('div');

      if (role === 'user') {
        messageDiv.className = 'message user';

        // ユーザーアバター
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar';
        const avatarIcon = document.createElement('i');
        avatarIcon.className = 'fas fa-user';
        avatarDiv.appendChild(avatarIcon);

        // メッセージコンテンツ
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = text;

        // タイムスタンプ
        const timeSpan = document.createElement('span');
        timeSpan.className = 'timestamp';
        timeSpan.textContent = timestamp;
        contentDiv.appendChild(timeSpan);

        // メッセージの組み立て
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
      } else {
        messageDiv.className = 'message bot';

        // AIアバター
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar';
        const avatarIcon = document.createElement('i');
        avatarIcon.className = 'fas fa-robot';
        avatarDiv.appendChild(avatarIcon);

        // メッセージコンテンツ
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        // AIメッセージの場合はマークダウンをサポート
        if (containsMarkdown(text)) {
          // マークダウンを含む場合
          const contentInner = document.createElement('div');
          contentInner.className = 'markdown-content';
          contentInner.innerHTML = renderMarkdown(text);

          // コードブロックがあれば、highlight.jsを適用
          if (hljs) {
            contentInner.querySelectorAll('pre code').forEach((block) => {
              hljs.highlightElement(block);
            });
          }

          contentDiv.appendChild(contentInner);
        } else {
          // マークダウンがない場合は段落に分ける
          const paragraphs = text.split('\n\n');

          for (const paragraph of paragraphs) {
            if (paragraph.trim()) {
              const p = document.createElement('p');
              p.textContent = paragraph;
              contentDiv.appendChild(p);
            }
          }
        }

        // タイムスタンプ
        const timeSpan = document.createElement('span');
        timeSpan.className = 'timestamp';
        timeSpan.textContent = timestamp;
        contentDiv.appendChild(timeSpan);

        // メッセージの組み立て
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
      }

      // Add to chat
      chatBox.appendChild(messageDiv);

      // Scroll to bottom
      scrollToBottom();
    }

    // Show typing indicator
    function showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message bot typing-message';
      typingDiv.innerHTML = `
        <div class="avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          <div class="typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;

      chatBox.appendChild(typingDiv);
      scrollToBottom();
      return typingDiv;
    }

    // Scroll chat to bottom
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Remove typing indicator
    function removeTypingIndicator() {
      const typingMessage = document.querySelector('.typing-message');
      if (typingMessage) {
        chatBox.removeChild(typingMessage);
      }
    }

    // Server-Sent Eventsの処理
    let eventSource = null;

    // ユーザーメッセージをUIに追加し、AIレスポンスを開始する関数
    async function send() {
      const text = inputField.value.trim();
      if (!text) return;

      // 入力フィールドをクリア
      inputField.value = '';
      inputField.focus();

      // ユーザーメッセージをUIに追加
      appendMessage('user', text);

      // テスト用コード - 「test」と入力するとマークダウンテストを実行（開発時のみ）
      if (text.toLowerCase() === 'test') {
        testMarkdownRendering();
        return;
      }

      // 既存のEventSourceがあれば閉じる
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }

      // ローディング表示
      const typingIndicator = showTyping();

      try {
        // POSTリクエスト
        const response = await fetch('/chat', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ message: text })
        });

        if (!response.ok) {
          throw new Error('Error: ' + response.status);
        }

        if (response.headers.get('Content-Type').includes('text/event-stream')) {
          // SSEストリーミングの場合
          processEventStream(response);
        } else {
          // 通常のJSONレスポンスの場合（以前の実装）
          const jsonData = await response.json();
          removeTypingIndicator();
          appendMessage('bot', jsonData.response);
        }
      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        appendMessage('bot', 'すみません、エラーが発生しました。もう一度お試しください。');
      }
    }

    // SSEを処理する関数
    function processEventStream(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let assistant_text = '';

      // メッセージ表示用の要素を作成
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'avatar';
      const avatarIcon = document.createElement('i');
      avatarIcon.className = 'fas fa-robot';
      avatarDiv.appendChild(avatarIcon);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      const contentInner = document.createElement('div');
      contentInner.className = 'markdown-content';
      contentDiv.appendChild(contentInner);

      const timeSpan = document.createElement('span');
      timeSpan.className = 'timestamp';
      timeSpan.textContent = formatTimestamp();
      contentDiv.appendChild(timeSpan);

      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(contentDiv);

      // 読み込み開始
      read();

      function read() {
        reader.read().then(({ done, value }) => {
          if (done) {
            // ストリーム終了、必要なクリーンアップを行う
            removeTypingIndicator();

            // マークダウンの完全なレンダリング
            if (containsMarkdown(assistant_text)) {
              contentInner.innerHTML = renderMarkdown(assistant_text);

              // コードブロックがあれば、highlight.jsを適用
              if (hljs) {
                contentInner.querySelectorAll('pre code').forEach((block) => {
                  hljs.highlightElement(block);
                });
              }
            } else {
              // マークダウンがない場合は段落に分ける
              contentInner.innerHTML = '';
              const paragraphs = assistant_text.split('\n\n');
              for (const paragraph of paragraphs) {
                if (paragraph.trim()) {
                  const p = document.createElement('p');
                  p.textContent = paragraph;
                  contentInner.appendChild(p);
                }
              }
            }

            return;
          }

          // 受信したバイナリデータを文字列に変換して蓄積
          buffer += decoder.decode(value, { stream: true });

          // イベントデータを解析
          const lines = buffer.split('\n');
          buffer = lines.pop() || ''; // 最後の不完全な行は次回処理のために保持

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const eventData = JSON.parse(line.substring(6));

                if (eventData.text) {
                  // 最初のテキストチャンクが来たら、タイピングインジケータを削除しメッセージ要素を追加
                  if (!assistant_text) {
                    removeTypingIndicator();
                    chatBox.appendChild(messageDiv);
                  }

                  // テキストを追加
                  assistant_text += eventData.text;

                  // 暫定的なレンダリング（ストリーミング表示）
                  if (containsMarkdown(assistant_text)) {
                    contentInner.innerHTML = renderMarkdown(assistant_text);
                  } else {
                    contentInner.innerHTML = '';
                    const paragraphs = assistant_text.split('\n\n');
                    for (const paragraph of paragraphs) {
                      if (paragraph.trim()) {
                        const p = document.createElement('p');
                        p.textContent = paragraph;
                        contentInner.appendChild(p);
                      }
                    }
                  }

                  // 自動スクロール
                  scrollToBottom();
                }

                if (eventData.error) {
                  // エラーメッセージの処理
                  console.error('Error from server:', eventData.error);
                  removeTypingIndicator();
                  appendMessage('bot', 'すみません、エラーが発生しました: ' + eventData.error);
                }

                if (eventData.complete) {
                  // ストリーム完了通知
                  console.log('Stream complete');
                }
              } catch (e) {
                console.error('Error parsing event data:', e, line.substring(6));
              }
            }
          }

          // 次のチャンクを読み込む
          read();
        }).catch(error => {
          console.error('Error reading stream:', error);
          removeTypingIndicator();
          appendMessage('bot', 'すみません、データの読み込み中にエラーが発生しました。もう一度お試しください。');
        });
      }
    }

    // デモンストレーション用のテストメッセージ
    function testMarkdownRendering() {
      const markdownExamples = [
        "# マークダウンテスト\n\n**太字**と*斜体*と`コード`のテスト。\n\nコードブロック:\n```javascript\nconsole.log('Hello, world!');\n```\n\nリスト:\n- 項目1\n- 項目2\n  - ネストした項目\n\n> これは引用です。\n\n[リンク](https://example.com)",
        "テーブルのテスト:\n\n| 項目 | 価格 |\n|------|------|\n| りんご | 100円 |\n| バナナ | 80円 |"
      ];

      // マークダウンのテストメッセージを表示
      appendMessage('bot', markdownExamples[0]);
      setTimeout(() => {
        appendMessage('bot', markdownExamples[1]);
      }, 1000);
    }

    // Clear chat history
    function clearChat() {
      if (!confirm('チャット履歴をクリアしますか？')) return;

      try {
        fetch('/clear', {
          method: 'POST',
          headers: getAuthHeaders()
        })
        .then(res => res.json())
        .then(data => {
          // Clear UI
          document.getElementById('chat-box').innerHTML = '';

          // Add welcome message
          appendMessage('bot', 'こんにちは！<br>まずは左側「CRM情報と連携する」にある情報を連携するボタンをクリックしてください☺️');
        })
        .catch(error => {
          console.error('Error clearing chat:', error);
          alert('チャットのクリアに失敗しました。もう一度お試しください。');
        });
      } catch (error) {
        console.error('Error clearing chat:', error);
        alert('チャットのクリアに失敗しました。もう一度お試しください。');
      }
    }
  </script>
</body>

</html>